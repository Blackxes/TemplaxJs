"use strict";var _createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||!1;descriptor.configurable=!0;"value"in descriptor&&(descriptor.writable=!0);Object.defineProperty(target,descriptor.key,descriptor)}}return function(Constructor,protoProps,staticProps){protoProps&&defineProperties(Constructor.prototype,protoProps);staticProps&&defineProperties(Constructor,staticProps);return Constructor}}();function _defineProperty(obj,key,value){key in obj?Object.defineProperty(obj,key,{value:value,enumerable:!0,configurable:!0,writable:!0}):obj[key]=value;return obj}function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor))throw new TypeError("Cannot call a class as a function")}!function r(e,n,t){function o(i,f){if(!n[i]){if(!e[i]){var c="function"==typeof require&&require;if(!f&&c)return c(i,!0);if(u)return u(i,!0);var a=new Error("Cannot find module '"+i+"'");throw a.code="MODULE_NOT_FOUND",a}var p=n[i]={exports:{}};e[i][0].call(p.exports,function(r){return o(e[i][1][r]||r)},p,p.exports,r,e,n,t)}return n[i].exports}for(var u="function"==typeof require&&require,i=0;i<t.length;i++)o(t[i]);return o}({1:[function(require,module,exports){var Parser=require("./HTMLParser.js"),Config=require("./Configuration.js");exports.tprocess=function TemplateProcessClass(id,template,userMarkup,isSubProcess){_classCallCheck(this,TemplateProcessClass);this.id=id||null;this.template=template||null;this.userMarkup=userMarkup||null;this.baseMarkup=null;this.currentQuery=null;this.isSubProcess=isSubProcess||!1;this.options=Object.assign({},Config.parsing.optionSets.templateProcess)};exports.template=function(){function TemplateClass(id,value,options){_classCallCheck(this,TemplateClass);this.id=id&&id.constructor===String?id:"";this._value=value||"string"==typeof value?value:"";this.options=options||{}}_createClass(TemplateClass,[{key:"value",get:function(){return!this._value&&this.id?Parser.parser.getTemplate(this.id)._value:this._value||""}}]);return TemplateClass}();exports.rule=function RuleClass(id,rule,request,key,value,options){_classCallCheck(this,RuleClass);this.id=id;this.rule=rule||null;this.request=request||null;this.key=key||null;this.value=value||null;this.options=options||null};exports.query=function(_exports$rule){!function(subClass,superClass){if("function"!=typeof superClass&&null!==superClass)throw new TypeError("Super expression must either be null or a function, not "+typeof superClass);subClass.prototype=Object.create(superClass&&superClass.prototype,{constructor:{value:subClass,enumerable:!1,writable:!0,configurable:!0}});superClass&&(Object.setPrototypeOf?Object.setPrototypeOf(subClass,superClass):subClass.__proto__=superClass)}(QueryClass,exports.rule);function QueryClass(processId,rule,template){var isPostQuery=3<arguments.length&&void 0!==arguments[3]&&arguments[3];_classCallCheck(this,QueryClass);var _this2=function(self,call){if(!self)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!call||"object"!=typeof call&&"function"!=typeof call?self:call}(this,(QueryClass.__proto__||Object.getPrototypeOf(QueryClass)).call(this,rule.id,rule.rule,rule.request,rule.key,rule.value,rule.options));_this2.processId=processId;_this2.template=template||null;_this2.isPostQuery=isPostQuery||!1;return _this2}return QueryClass}();exports.processResponse=function ProcessResponseClass(replacement,value,postQuery,indexOffSet){_classCallCheck(this,ProcessResponseClass);this.replacement=replacement||"";this.value=value||"";this.postQuery=void 0!==postQuery?postQuery:null;this.indexOffSet=null!=indexOffSet?indexOffSet:null;this.postQuery&&(this.postQuery.isPostQuery=!0)};var TemplatesClass=function(){function TemplatesClass(){_classCallCheck(this,TemplatesClass);this.templates={};this.templates.hp_debug_messages=this.hp_debug_messages()}_createClass(TemplatesClass,[{key:"hp_debug_messages",value:function(){return'\n\t\t\t<div class="hp-debug-messages">\n\t\t\t{{ foreach: hp_debug_messages }}\n\t\t\t\t<p>{{ message }}</p>\n\t\t\t{{ foreach end: hp_debug_messages }}\n\t\t\t</div>\n\t\t'}}]);return TemplatesClass}();exports.templates=(new TemplatesClass).templates},{"./Configuration.js":2,"./HTMLParser.js":3}],2:[function(require,module,exports){exports.general={};exports.general.systemPrefix="hp_";exports.regex={};exports.regex.extractRule=function(){return new RegExp("{{([^<>]*?)}}","g")};exports.regex.extractRequest=function(){return new RegExp("([\\w-]+)(?:[\\w\\s:-]+)?","g")};exports.regex.extractKey=function(){return new RegExp("{{\\s*(?:[\\w-]+)\\s*:\\s*([\\w-]+)(?:[\\w\\s:-]+)?","g")};exports.regex.extractArea=function(query,id){return new RegExp(query.rule+"(.*?){{\\s*"+query.request+"\\s+end\\s*:\\s*"+id+"\\s*}}","g")};exports.debug={};exports.debug.display=!0;exports.debug.display_trace=!0;exports.parsing={};exports.parsing.optionSets={default:{render:!0,wrap:"|"},templateProcess:{processRuleCounter:!0,wrapContent:!0},templateInline:{renderInline:!1}}},{}],3:[function(require,module,exports){var Config=require("./Configuration.js"),Classes=(require("./RequestParser.js"),require("./RuleParser.js"),require("./Classes.js")),HTMLParser=new(function(){function HTMLParserClass(){_classCallCheck(this,HTMLParserClass);this.templates=new Map;this.tprocesses=new Set;this.ruleCounter=0;this.processCounter=0}_createClass(HTMLParserClass,[{key:"parse",value:function(id,markup,options){var displayParsingTime=!(3<arguments.length&&void 0!==arguments[3])||arguments[3];if(!(!this.templates.has(id)||options&&options.render)){var template;if(!templateDefinition||markup&&markup.constructor!==Object)return"";template=templateDefinition instanceof Classes.template?templateDefinition:this.getTemplate(templateDefinition);var start=Date.now(),content=this._parse(template,markup),end=Date.now();displayParsingTime&&console.log("HTParser: parsing took %sms",end-start);return content}}},{key:"_parse",value:function(template,markup,options){return this._processTemplate(template,markup,function(query){return RequestProcessor.requestProcessor.processRequest(query)},null,options)}},{key:"_processTemplate",value:function(template,markup,_callback,_this){var options=4<arguments.length&&void 0!==arguments[4]?arguments[4]:{},tProcess=this._createTProcess(template,markup);tProcess.options=Object.assign({},tProcess.options,options);var regExtractRule=Config.regex.extractRule(),callback=_callback&&_callback.constructor==Function?_callback.bind(_this||this):function(){return null};tProcess.baseMarkup=this._buildBaseMarkup(tProcess);for(var rawRule=null,content=template.value,oldLastIndex=regExtractRule.lastIndex,postQuerries=[];rawRule=regExtractRule.exec(content);){var _rule=this._buildRule(tProcess,rawRule[0]),query=new Classes.query(tProcess.id,_rule,content.substring(oldLastIndex),!1);tProcess.currentQuery=query;console.log(query);var response=this._reviewProcessResponse(tProcess,callback(query));response.postQuery&&postQuerries.push(response.postQuery);regExtractRule.lastIndex+=null!==response.indexOffSet?Number(response.indexOffSet):-(query.rule.length-response.value.length);oldLastIndex=regExtractRule.lastIndex;content=content.replace(response.replacement,query.options.wrap.replace("|",response.value))}postQuerries.forEach(function(postQuery){var response=callback(postQuery);content=content.replace(response.replacement,response.value)});this._deleteTProcess(tProcess.id);return content}},{key:"_buildBaseMarkup",value:function(tProcess){if(!(tProcess&&tProcess instanceof Classes.tprocess))return{};var base={};base[Config.general.systemPrefix+"templateId"]=tProcess.template.id||tProcess.isSubProcess?tProcess.template.id:"Undefined template id";return base}},{key:"_buildRule",value:function(tProcess,rawRule){var request=this._extractRulePiece(rawRule,Config.regex.extractRequest())||null,key=this._extractRulePiece(rawRule,Config.regex.extractKey())||null,options=Object.assign({},Config.parsing.optionSets.default,Config.parsing.optionSets[request]||{}),rule=new Classes.rule(tProcess.options.processRuleCounter?ruleIdCounter++:ruleIdCounter,rawRule,request,key,null,options),prioKey=key||request,markup=Object.assign({},tProcess.baseMarkup,this._buildRuleMarkup(rule),tProcess.userMarkup),markupConfig=this._applyMarkupConfigOnRuleConfig(rule,markup[prioKey]);rule.options=markupConfig.options;rule.value=markupConfig.value;return rule}},{key:"_applyMarkupConfigOnRuleConfig",value:function(rule,config){var processedConfig={value:null,options:Object.assign({},rule.options)};if(!rule||!config)return processedConfig;if(config.constructor===String)processedConfig.value=config;else if(config.constructor===Function)processedConfig.value=config();else if(config.constructor===Object){config.value?processedConfig.value=config.value.constructor===Function?config.value():config.value:processedConfig.value=config;config.options&&(processedConfig.options=Object.assign(processedConfig.options,this._processOptions(config.options)))}else processedConfig.value=config;return processedConfig}},{key:"_processOptions",value:function(options){if(!options||options.constructor!==Object||!Object.keys(options).length)return{};for(var option in options)options[option]&&options[option].constructor===Function&&(options[option]=options[option]());return options}},{key:"_buildRuleMarkup",value:function(rule){var _markup;if(!(rule&&rule instanceof Classes.rule))return{};var markup=(_defineProperty(_markup={},Config.general.systemPrefix+"hp_rule",rule.rule),_defineProperty(_markup,Config.general.systemPrefix+"hp_request",rule.request),_defineProperty(_markup,Config.general.systemPrefix+"hp_key",rule.key||""),_markup);for(var i in rule.options)markup[Config.general.systemPrefix+"hp_option_"+i]=rule.options[i];return markup}},{key:"_getRequestValue",value:function(prioKey,markup){var config={value:null,options:{}},value=markup[prioKey];if(!value)return config;if(value.constructor===String)config.value=value;else if(value.constructor===Object){config.value=value.value||null;config.options=this._processOptions(value.options)}return config}},{key:"_extractRulePiece",value:function(source,regex){var callback=2<arguments.length&&void 0!==arguments[2]?arguments[2]:null,match=regex.exec(source);if(!match)return null;if(callback&&callback.constructor===Function){for(var results=[],i=1;match[i];i++)results.push(callback(match[i]));return results}return match[1]||match[0]||""}},{key:"_reviewProcessResponse",value:function(tProcess,response){if(!(response&&response instanceof Classes.processResponse))return new Classes.processResponse(tProcess.currentQuery.rule,"",!1);response.replacement&&response.replacement.constructor===String||(response.replacement=rule.rule);(!response.value||response.value.constructor!==String&&response.value.constructor!==Function)&&(response.value=String(response.value));return response}},{key:"_createTProcess",value:function(template,markup){if(template instanceof Classes.template){if(this._hasTProcess(template.id))return null;var freshId=this._getFreeTProcessId();this.tprocesses[freshId]=new Classes.tprocess(freshId,template,markup,Boolean(template.id));return this._getTProcess(freshId)}}},{key:"_deleteTProcess",value:function(processId){if(!this._getTProcess(processId))return null;delete this.tprocesses[processId];return Boolean(this._getTProcess(processId))}},{key:"_hasTProcess",value:function(processId){return Boolean(this.tprocesses[processId])}},{key:"_getTProcess",value:function(processId){return this.tprocesses[processId]}},{key:"_getFreeTProcessId",value:function(){for(var id=++Object.values(this.tprocesses).length;this.tprocesses[this.tprocesses.length];)id++;return id}},{key:"setTemplateOptions",value:function(templateId,definition,value){if(!this.hasTemplate(templateId))return!1;if(definition||value)if(definition.constructor===Object)this.getTemplate(templateId).options=definition;else{if(definition.constructor!==String)return!1;this.getTemplate(templateId).options[definition]=value}else this.getTemplate(templateId).options={};return!0}},{key:"getTemplate",value:function(templateId){var includeCoreTemplates=1<arguments.length&&void 0!==arguments[1]&&arguments[1];return this.templates[templateId]&&(includeCoreTemplates||templateId.indexOf(Config.general.systemPrefix))?this.templates[templateId]:null}},{key:"getTemplates",value:function(){var includeCoreTemplates=0<arguments.length&&void 0!==arguments[0]&&arguments[0],templates={};for(var i in this.templates)!includeCoreTemplates&&i.indexOf(Config.general.systemPrefix)&&(templates[i]=this.templates[i]);return templates}},{key:"hasTemplate",value:function(templateId){return Boolean(this.templates[templateId])}}]);return HTMLParserClass}());exports.parser=HTMLParser},{"./Classes.js":1,"./Configuration.js":2,"./RequestParser.js":4,"./RuleParser.js":5}],4:[function(require,module,exports){var Config=require("./Configuration.js"),Parser=require("./HTMLParser.js"),Classes=require("./Classes.js"),RequestProcessor=function(){function RequestProcessorClass(){_classCallCheck(this,RequestProcessorClass)}_createClass(RequestProcessorClass,[{key:"processRequest",value:function(query){return"false"==String(query.options.render).toLowerCase()?new Classes.processResponse(query.rule,null,!1):query.request in this?this[query.request](query):new Classes.processResponse(query.rule,query.value,!1)}},{key:"template",value:function(query){if(!query.key)return null;if(!Parser.parser.hasTemplate(query.key))return new Classes.processResponse(query.rule,query.isPostQuery?"":query.rule,!query.isPostQuery&&query,0);var response=new Classes.processResponse(query.rule,null,!1),content=Parser.parser.parse(query.key,query.value,!1);response.value=content;return response}},{key:"templateInline",value:function(query){if(!query.key)return null;var response=new Classes.processResponse(query.rule,"",!1),templateMatch=Config.regex.extractArea(query,query.key).exec(query.template);if(!templateMatch)return response;if(!Parser.parser.registerTemplate(query.key,templateMatch[1]))return response;response.replacement=templateMatch[0];query.options.renderInline&&(response.value=Parser.parser.parse(query.key,query.value));return response}},{key:"foreach",value:function(query){if(!query.key||!query.value||query.value&&query.value.constructor!==Array)return null;var response=new Classes.processResponse(query.rule,"",!1),foreachMatch=Config.regex.extractArea(query,query.key).exec(query.template);if(!foreachMatch)return response;response.replacement=foreachMatch[0];var template=foreachMatch[1],content="";query.value.forEach(function(currentMarkup){content+=Parser.parser.parse(new Classes.template(null,template),currentMarkup,!1)});response.value=content;return response}},{key:"debug",value:function(query){var response=new Classes.processResponse(query.rule,"no data found",!1);response.value="Currently not implemented!";return response}}]);return RequestProcessorClass}();exports.requestProcessor=RequestProcessor},{"./Classes.js":1,"./Configuration.js":2,"./HTMLParser.js":3}],5:[function(require,module,exports){},{}],6:[function(require,module,exports){var Parser=require("./HTMLParser.js").parser;window&&(window.js_htparser=Parser);exports.parser=Parser},{"./HTMLParser.js":3}]},{},[6]);